<!DOCTYPE html>
<html lang="br">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1,
    shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <title>Evandro</title>
</head>

<body>
    <nav class="navbar navbar-expand-sm navbar-light navbar bg-light">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="index.html">Clientes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Contato.html">Contato</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    </br>
     <!------------------ Botão  modal ---------------------------------------------------------------->
     <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal"
            onclick="return abreModal()">Adicionar</button>
    </div>
    <!------------------ Modal de Cadastro de Clientes------------------------------------------------>
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Cadastro de Clientes</h5>
                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                    </div>
                    <br>
                    <div class="d-none">
                        <label for="novo-id" class="form-label">Id:</label>
                        <input type="text" class="form-control" id="novo-id" required>
                    </div>
                    <div class="container">
                        <label for="novo-nome" class="form-label">Nome:</label>
                        <input type="text" class="form-control" id="novo-nome" required>
                    </div>
                    <br>
                    <div class="container">
                        <label for="novo-email" class="form-label">email:</label>
                        <input type="text" class="form-control" id="novo-email">
                        <br>
                    </div>
                    <div class="container">
                        <label for="novo-telefone" class="form-label">Telefone:</label>
                        <input type="text" class="form-control" id="novo-telefone">
                        <br><br>
                    </div>
                    <br><br>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" onclick="novoUsuario()"
                        data-bs-dismiss="modal">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!---------------------------------- Modal Delete ------------------------------------------------>
    <div class="modal fade" id="modaldelete" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Exclusão</h5>
                    <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" id="modaldelete_body">
                    Confirma a exclusão do registro?
                </div>
                <div class="d-none">
                    <input type="text" class="form-control" id="input-id-delete">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="return excluirUsuario()">Confirmar a
                        Exclusão</button>
                </div>
            </div>
        </div>
    </div>


    <!----------------------------------Tabela usando PUSH------------------------------------------------>
    <form class="d-flex">
        <div class="container">
            <h2>Lista de Clientes</h2>
            <table class="table table-fluid" table id="tableclientes">
                <Tbody>
                    <script>
                        async function getAllUsers() {
                            const response = await fetch('/api/user')
                            if (response.status != 200) {
                                alert('erro')
                                return
                            }
                            $(document).ready(function () {
                                $('#tableclientes').DataTable({
                                    "language": {
                                        "lengthMenu": "Mostrando _MENU_ Registros",
                                        "zeroRecords": "Desculpe - Nada Encontrado",
                                        "info": "Mostrando página _PAGE_ de _PAGES_",
                                        "infoEmpty": "Nenhum Registro Disponível",
                                        "infoFiltered": "(filtrado de _MAX_ registros no total)"
                                    }
                                });
                            });
                            const tbl = document.getElementById('tableclientes')

                            const resultAsJS = await response.json()
                            //console.table(resultAsJS)
                            //d.innerHTML = JSON.stringify(resultAsJS)
                            const arrRows = []

                            for (const row of resultAsJS) {
                                arrRows.push(
                                    '<tr><th>' + row.id + '</th>',
                                    '<td>' + row.nome + '</td>',
                                    '<td>' + row.email + '</td>',
                                    '<td>' + row.telefone + '</td>',
                                    '<th><button type="button" class="btn btn-sm btn-primary" onclick="abreModal(\'' + row.id + '\')" data-bs-toggle="modal" data-bs-target="#exampleModal">Editar</button>',
                                    '<button type="button" class="btn btn-sm btn-danger" onclick="abremodalDelete(\'' + row.id + '\')" data-bs-toggle="modal" data-bs-target="#modaldelete">Excluir</button></th></tr>'
                                )
                            }

                            tbl.innerHTML =
                                '<thead class="table-light">'
                                + '<tr>'
                                + '<th>ID</th>'
                                + '<td>Nome</td>'
                                + '<td>Email</td>'
                                + '<td>Telefone</td>'
                                + '<td>Action</td>'
                                + '</tr>'
                                + '</thead>'
                                + arrRows.join('');
                            //tbl.innerHTML = arrRows.join('') 

                        }
      </script>
      </tbody>
     </table>
    </div>
    </form>
<!---------------------------Cadastrar e Editar Usuario metodo POST------------------------------>
    <script>
        async function abreModal(id) {
            if (id == '' || id == undefined || id == 0) {
                document.getElementById('novo-id').value = ''
                document.getElementById('novo-nome').value = ''
                document.getElementById('novo-email').value = ''
                document.getElementById('novo-telefone').value = ''
            }
            else {
                const response = await fetch('/api/user/' + id)
                if (response.status != 200) {
                    alert('erro')
                    return
                }
                const resultAsJS = await response.json()
                document.getElementById('novo-id').value = resultAsJS.id
                document.getElementById('novo-nome').value = resultAsJS.nome
                document.getElementById('novo-email').value = resultAsJS.email
                document.getElementById('novo-telefone').value = resultAsJS.telefone

            }
            $('#exampleModal').modal({ keyboard: true })
        }
        async function novoUsuario() {
            const idValue = document.getElementById('novo-id').value
            const input_nome = document.getElementById('novo-nome')
            const input_email = document.getElementById('novo-email')
            const input_telefone = document.getElementById('novo-telefone')
            const requestOpt = {
                headers: {
                    'Content-Type': 'application/json'
                },
                method: (idValue == '' || idValue == undefined || idValue == 0) ? 'POST' : 'PUT',
                body: JSON.stringify({
                    id: idValue,
                    nome: input_nome.value,
                    email: input_email.value,
                    telefone: input_telefone.value
                })
            }

            const response = await fetch('/api/user', requestOpt)
            if (response.status != 200) {
                alert('erro')
                return
            }

            getAllUsers()
        }
        getAllUsers()
    </script>
    <!----------------------------------------Deletar Usuario---------------------------------------->
    <script>
        async function abremodalDelete(id) {
            const response = await fetch('/api/user/' + id)
            if (response.status != 200) {
                alert('erro')
                return
            }
            const resultAsJS = await response.json()
            document.getElementById("modaldelete_body").innerHTML = 'Confirma a exclusão de "' + resultAsJS.nome + '"'
            document.getElementById("input-id-delete").value = id
            $('#modaldelete').modal({ keyboard: true })
        }

        async function excluirUsuario() {
            const idValue = document.getElementById('input-id-delete').value
            const requestOpt = {
                headers: {
                    'Content-Type': 'application/json'
                },
                method: 'DELETE'
            }
            const response = await fetch('/api/user/' + idValue, requestOpt)
            if (response.status != 200) {
                alert('erro')
                return
            }
            $('#modaldelete').modal('toggle');
            getAllUsers()
        }

        getAllUsers()


    </script>
    <!--script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js"
        integrity="sha384-cn7l7gDp0eyniUwwAZgrzD06kc/tftFf19TOAs2zVinnD/C7E91j9yyk5//jjpt/"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>        
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>        
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
</body>

</html>